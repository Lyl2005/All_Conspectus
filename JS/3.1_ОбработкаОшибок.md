# Исключение

**Исключение** - это некоторое событие, сигнализирующее о возникновении нештатной ситуации или ошибки.

**Возбудить (создать, бросить) исключение** - просигнализировать о такой ошибке или исключительной ситуации.

**Перехватить исключение** - значит предпринять действия по обработке исключения и восстановления нормальной работоспособности кода.

Возбуждение исключения производится оператором `throw`, перехват - командой `catch` (связкой операторов `try-catch-finally`).

<br>

Синтаксис оператора `throw`:

```js
throw выражение;
```

"выражение" (результат его вычисления) может представлять из себя практически любой тип данных: строку, число, булево значение, объект. Например число, представляющее код ошибки, строку, содержащую текст ошибки.

## **Пример**

пример демонстрирует проверку входного параметра в рекурсивной функции при вычислении:

```js
function testFactorial(inputData) {

  if (inputData == 0) {return 1}
  if (inputData < 0)                             // Проверяем - положительное ли число
    throw "Число не должно быть меньше нуля";    // Если отрицательное - "бросаем" исключение

  return (inputData - 1)?(inputData * testFactorial(inputData - 1)):inputData;  // Вычисление факториала
}
```

В примере, если на вход функции будет подано число меньше 0, то будет сгенерирована ошибка с текстом "Число не должно быть меньше нуля" и произойдет выход из функции.

Если ввод корректный, то будет вычислен факториал числа, поданного на вход.
___

<br>

Как только исключение создано, интерпретатор JavaScript прерывает нормальное выполнение кода и начинает поиск обработчика исключений - конструкции `try/catch/finally`.

Синтаксис конструкции:

```JavaScript
try {
  // код, который нужно "попробовать"
  // в этом коде может быть брошено исключение
} catch(exception_variable) {
  // в этом месте пишется код, который выполняется только в случае обнаружения 
  // исключения в предыдущем блоке "trу" 
  // в случае возникновения исключения, в переменную exception_variable будет передан 
  // код возникшей ошибки, например аргумент оператора throw
} finally {
  // Код в этом блоке будет выполнен всегда, независимо от результата завершения блока try:
  // и при завершении без ошибки, и при завершении с ошибкой, и при завершении по любому оператору перехода
  // (break, continue, return)
}
```

Блоки `catch` и `finally` не являются строго обязательными, однако хотя бы один из них должен присутствовать в конструкции.

## **Пример**

Рассмотрим пример с использованием функции **factorial()**

```JavaScript
function testFactorial(inputData) {
  if (inputData == 0) {return 1}
  if (inputData < 0)                                // Проверяем на положительность
    throw "Число не должно быть меньше нуля";       // Отрицательное? тогда "бросаем" исключение
  return (inputData - 1) ? (inputData * testFactorial(inputData - 1)) : inputData;
}

// переменная для входного параметра, зададим ее вручную
var myNumber = -5;
try {       // конструкция обработки ошибок
  document.write(testFactorial(myNumber));          // Попытка вызова функции
} catch(ex) {
  document.write(ex);   /* если в функции произойдет исключение, то будет выведен текст,
                        который мы использовали в параметре оператора throw */
}
```

**ex** - объект ошибки, назвать его можно как угодно. Внутри catch(ex) можно даже не использовать этот объект.

```js
catch(ex) {
    alert("ошибка поймана!");
}
```

Объект ошибки генерируется, когда возникает ошибка, и содержит свойства:

+ `name` - имя ошибки (например, ReferenceError - для неопределенной ошибки)
+ `message` - текстовое сообщение о деталях ошибки
+ `stack` - текущий стек вызова (строка, содержащая инфу о последовательности вложенных вызовов, которые привели к ошибке)

Благодаря этим свойствам - можем вывести алерт с текстом ошибки `ex.message`, или сохранить в какой-нибудь документ информацию об ошибке `document.write(ex.stack)`, чтобы потом можно было понять что к этой ошибке привело и как это поправить.

<br>

**Важный момент** - конструкции `try/catch/finally` могут быть многократно вложенными. В такой ситуации нам зачастую необходимо проверить - а что за исключение возникло, и если это не то исключение, которое мы ждали и готовы обработать, то нужно его отправить дальше. Вариант "не перехватывать" мы реализовать не можем, однако можно перехватить, проверить и если это не то, что нужно - сгенерировать заново, как бы послать дальше.

Посмотрим, как бы мы реализовали предыдущий пример с таким уточнением:

```JavaScript
function testFactorial(inputData) {
  if (inputData == 0) {return 1}
  if (inputData < 0)                                // Проверяем на положительность
    throw "Число не должно быть меньше нуля";       // Отрицательное? тогда "бросаем" исключение
  return (inputData - 1) ? (inputData * testFactorial(inputData - 1)) : inputData;
}

// переменная для входного параметра, зададим ее вручную
var myNumber = -5;
try {       // конструкция обработки ошибок
  document.write(testFactorial(myNumber));          // Попытка вызова функции
} catch(ex) {
  if (ex != "Число не должно быть меньше нуля")     // Проверяем - если исключение не наше
    throw (ex);                                     // то "бросаем" его дальше, как бы пропускаем.
  document.write(ex);                               // Вывод строки ошибки если исключение "наше"
}
```

В этом примере мы перед тем как вывести ошибку на экран, проверяем - та ли это ошибка, которая была сгенерирована оператором `throw` в нашей функции. Если нет, то генерируем ее заново.
___

<br>

Стандартный объект `Error`, который используется при возбуждении исключений.

Командой `throw` может быть выброшен практически любой объект, однако стандартно при возникновении ошибок выбрасывается объект класса `Error` или его подклассы.

```JavaScript
new Error(message);
```
Этой командой создается новый экземпляр объекта `Error`, а текст "message" записывается в свойство объекта с `message`.

Простой пример вызова конструктора `Error`:

```JavaScript
try {
  throw new Error('Что-то пошло не так!');
} catch (e) {
  console.log(e.name + ': ' + e.message);
}
```

В данном примере создали объект типа `Error` с именем `Error` и текстом сообщения об ошибке "Что-то пошло не так !".

<br>

## **Пример**

Для использования объекта в функции из предыдущего примера:

```JavaScript
function testFactorial(inputData) {
  if (inputData == 0) {return 1}
  if (inputData < 0)                                // Проверяем на положительность
    throw "Число не должно быть меньше нуля";       // Отрицательное? тогда "бросаем" исключение
  return (inputData - 1) ? (inputData * testFactorial(inputData - 1)) : inputData;
}

var myNumber = -5;
try {       // конструкция обработки ошибок
  document.write(testFactorial(myNumber));                  // Попытка вызова функции
} catch(ex) {
  if (ex.message != "Число не должно быть меньше нуля")     // Проверяем - если исключение не наше
    throw new Error(ex);                                    // то "бросаем" его дальше, как бы пропускаем.
  document.write(ex.name + ': ' + ex.message);              // Вывод строки ошибки если исключение "наше"
}

// Error: Число не должно быть меньше нуля
```
___


